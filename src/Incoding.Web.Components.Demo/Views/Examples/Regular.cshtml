@using Incoding.Web.Components.Grid;
@{
    Action<ColumnListBuilder<SampleData>> periodCols = cols => cols.Spreaded(s => s.Period, 5,
                                 (cols, i) =>
                                 {
                                     cols.Stacked(s => s.Title(DateTime.Now.AddDays(i).ToShortDateString()),
                                                  cols =>
                                                  {
                                                      cols.Add().Field(s => s.Hours).Title("Hrs").Width(70);
                                                      cols.Add().Field(s => s.JTD).Title("$").Width(70);
                                                  });
                                 });

    Action<ColumnListBuilder<SampleData>> regularCols = cols =>
                     {
                        cols.Add().Content(
                        @<text>
                            @Html.Components().GridUtils.ExpandButton(settings =>
                            {
                                settings.Content = "";
                            })
                        </text>).Width(40);

                        cols.Add().Field(s => s.Name).Width(70);
                        cols.Add().Field(s => s.Description).Title("Notes").Width(200);

                        cols.Add().Field(s => s.Amount).Width(70);
                        cols.Add().Field(s => s.AmountPercentage).Title("Amount %").Width(70);
                        cols.Add().Field(s => s.Balance).Width(70);

                        cols.Stacked(s => s.Title("Dates"),
                                        cols =>
                                        {
                                            cols.Add().Field(s => s.Start).Width(70);
                                            cols.Add().Field(s => s.End).Width(70);
                                        });
                     };
}

@(Html.Components().Grid<SampleData>("grid")
      .Split(splitting =>
      {
            splitting.Add("regular", table =>
            {
                table.Css("table table-bordered table-component")
                     .Rows(row => row.Css("tr-item-calculate"))
                     .Columns(regularCols)
                     .Nested(s => s.Children, nested =>
                     {
                            nested.Columns(regularCols);
                     });
            });

            splitting.Add("period", table =>
            {
                table.Css("table table-bordered table-component")
                     .Rows(row => row.Css("tr-item-calculate"))
                     .Columns(periodCols);

                table.Nested(s => s.Children, nested =>
                {
                    nested.Columns(periodCols);
                });
            });
      })
      .Bind(iml => iml.When(Bindings.Grid.Init)
                      .OnSuccess(dsl =>
                      {
                          dsl.Self().JQuery.PlugIn("websocketLoader", new {
                              chunkSize = 40,
                              scroller = ".splitter-panel"
                          });
                      })
                      .When(Bindings.Websocket.Start)
                      .OnSuccess(dsl => dsl.Self())
                      .When(Bindings.Websocket.LoadChunk)
                      .OnSuccess(dsl => dsl.Self().JQuery.Call("data('splitGrid').appendData", Selector.Event.Data.For("data")))
                      .When(Bindings.Websocket.RenderChunk)
                      .OnSuccess(dsl =>
                      {
                          var start = Selector.Event.Data.For("start");
                          var end = Selector.Event.Data.For("end");

                          dsl.Self().JQuery.Call("data('splitGrid').renderRows", start, end);
                      })
                      .When(Bindings.Websocket.Complete)
                      .OnSuccess(dsl => dsl.Self()))
      .Virtualize(v =>
      {
          v.InfinteScrolling = true;
          v.ChunkSize = 40;
      })
      .UI(ui =>
      {
          ui.HighlightRowsOnHover = true;
      })
      .Render(useConcurrentRender: false))
